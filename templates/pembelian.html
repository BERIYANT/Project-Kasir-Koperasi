<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Kasir Koperasi - Pembelian</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  
  <style>
    :root {
      --green-main: #2d7a4f;
      --green-light: #e8f5e9;
      --green-dark: #1a5738;
      --gray-bg: #f9f9f9;
    }

    body {
      background: var(--gray-bg);
      font-family: "Poppins", "Segoe UI", sans-serif;
      color: #333;
      min-height: 100vh;
    }

    .navbar {
      background: var(--green-main);
      color: #fff;
      padding: 1.2rem 2rem;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15);
    }

    .navbar h3 {
      margin: 0;
      font-weight: 700;
      font-size: 1.8rem;
    }

    .content {
      max-width: 1200px;
      margin: 40px auto;
      background: #fff;
      padding: 30px 40px;
      border-radius: 12px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
    }

    .section-title {
      font-size: 1.4rem;
      font-weight: 600;
      color: var(--green-main);
      margin-bottom: 20px;
    }

    .supplier-box {
      background: linear-gradient(135deg, #fff 0%, var(--green-light) 100%);
      border: 2px solid var(--green-main);
      border-radius: 12px;
      padding: 25px 30px;
      margin-bottom: 30px;
      box-shadow: 0 3px 10px rgba(45, 122, 79, 0.1);
    }

    .supplier-box h5 {
      color: var(--green-main);
      font-weight: 700;
      margin-bottom: 20px;
      font-size: 1.2rem;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .form-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 15px;
    }

    .form-group {
      display: flex;
      flex-direction: column;
    }

    .form-group label {
      font-weight: 600;
      color: var(--green-dark);
      margin-bottom: 8px;
      font-size: 0.95rem;
    }

    .form-group label .required {
      color: #dc3545;
      margin-left: 3px;
    }

    .input-wrapper {
      display: flex;
      gap: 10px;
      align-items: center;
      width: 100%;
    }

    .input-wrapper input {
      flex: 1;
    }

    .btn-scan {
      background: var(--green-main);
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      white-space: nowrap;
      font-size: 0.9rem;
    }

    .btn-scan:hover {
      background: var(--green-dark);
    }

    .btn-delete {
      background: #dc3545;
      color: white;
      border: none;
      padding: 6px 12px;
      border-radius: 6px;
      font-weight: 600;
      cursor: pointer;
      font-size: 0.85rem;
      transition: all 0.3s ease;
    }

    .btn-delete:hover {
      background: #c82333;
      transform: scale(1.05);
    }

    .scanner-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.9);
      z-index: 9999;
      justify-content: center;
      align-items: center;
    }

    .scanner-overlay.active {
      display: flex;
    }

    .scanner-box {
      background: white;
      padding: 30px;
      border-radius: 12px;
      max-width: 600px;
      width: 90%;
      text-align: center;
    }

    .scanner-box h4 {
      color: var(--green-main);
      margin-bottom: 20px;
      font-weight: 600;
    }

    #reader {
      border: 3px solid var(--green-main);
      border-radius: 8px;
      overflow: hidden;
      max-width: 100%;
    }

    .scanner-hint {
      margin-top: 15px;
      color: #666;
      font-size: 0.9rem;
    }

    .btn-close-scanner {
      background: #dc3545;
      color: white;
      border: none;
      padding: 12px 30px;
      border-radius: 8px;
      margin-top: 20px;
      cursor: pointer;
      font-weight: 600;
    }

    .btn-close-scanner:hover {
      background: #c82333;
    }

    .summary-box {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: linear-gradient(135deg, var(--green-light) 0%, #c8e6c9 100%);
      padding: 30px 40px;
      border-radius: 12px;
      margin-bottom: 25px;
      box-shadow: 0 3px 10px rgba(45, 122, 79, 0.15);
      border: 2px solid var(--green-main);
    }

    .summary-item {
      text-align: center;
      flex: 1;
    }

    .summary-item h6 {
      color: var(--green-dark);
      font-size: 1.1rem;
      margin-bottom: 8px;
      text-transform: uppercase;
      letter-spacing: 1px;
      font-weight: 700;
    }

    .summary-item h2 {
      margin: 0;
      font-weight: 800;
      color: #1a5738;
      font-size: 2.2rem;
      text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
    }

    table {
      border-radius: 10px;
      overflow: hidden;
    }

    thead {
      background: var(--green-main);
      color: white;
    }

    thead th {
      text-transform: uppercase;
      font-weight: 600;
      text-align: center;
      padding: 15px;
    }

    tbody td {
      vertical-align: middle;
      padding: 15px;
    }

    tbody tr:not(#inputRow):hover {
      background: var(--green-light);
      transition: 0.3s ease;
    }

    #inputRow td {
      background: #f0f8f5;
      padding: 15px !important;
    }

    .form-control, .form-select {
      font-size: 16px;
      border: 1.5px solid #dcecdc;
      border-radius: 8px;
      padding: 10px 12px;
    }

    .form-control:focus, .form-select:focus {
      border-color: var(--green-main);
      box-shadow: 0 0 0 3px rgba(45, 122, 79, 0.15);
    }

    .btn-save {
      background: var(--green-main);
      color: #fff;
      border: none;
      padding: 15px 40px;
      font-size: 1.1rem;
      font-weight: 600;
      border-radius: 10px;
      transition: 0.3s ease;
    }

    .btn-save:hover {
      background: var(--green-dark);
      transform: translateY(-2px);
      box-shadow: 0 6px 15px rgba(45, 122, 79, 0.3);
    }

    .loading-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      z-index: 9999;
      justify-content: center;
      align-items: center;
    }

    .loading-content {
      background: white;
      padding: 40px;
      border-radius: 12px;
      text-align: center;
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
    }

    .loading-spinner {
      border: 5px solid #f3f3f3;
      border-top: 5px solid var(--green-main);
      border-radius: 50%;
      width: 60px;
      height: 60px;
      animation: spin 1s linear infinite;
      margin: 0 auto 20px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    @media (max-width: 768px) {
      .form-row {
        grid-template-columns: 1fr;
      }

      .summary-box {
        flex-direction: column;
        gap: 20px;
        padding: 20px;
      }
    }
  </style>
</head>
<body>
  <nav class="navbar">
    <h3>üõí Kasir Koperasi <small style="font-size: 1rem; opacity: 0.8;">‚Ä¢ Pembelian Barang</small></h3>
    <div style="margin-top: 10px;">
      <button id="btnDashboard" class="btn btn-light me-2">Lihat Stok</button>
      <button id="btnBack" class="btn btn-secondary me-2">‚¨Ö Kembali</button>
      <button id="btnForward" class="btn btn-secondary">‚û° Maju</button>
    </div>
  </nav>

  <div class="content">
    <div class="supplier-box">
      <h5>üìã Data Pembelian</h5>
      
      <div class="form-row">
        <div class="form-group">
          <label for="tanggal_pembelian">Tanggal Pembelian <span class="required">*</span></label>
          <input type="date" id="tanggal_pembelian" class="form-control" required>
        </div>

        <div class="form-group">
          <label for="nomor_faktur">Nomor Faktur Supplier</label>
          <input type="text" id="nomor_faktur" class="form-control" placeholder="Masukkan nomor faktur (opsional)">
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label for="supplier">Nama Supplier <span class="required">*</span></label>
          <select id="supplier" class="form-select" required>
            <option value="">-- Pilih Supplier --</option>
            <!-- Akan diisi via JS -->
          </select>
        </div>

        <div class="form-group">
          <label for="metode_pembayaran">Metode Pembayaran <span class="required">*</span></label>
          <select id="metode_pembayaran" class="form-select" required>
            <option value="">-- Pilih Metode --</option>
            <option value="Tunai">Tunai</option>
            <option value="Transfer">Transfer Bank</option>
            <option value="Kredit">Kredit/Tempo</option>
          </select>
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label for="keterangan">Keterangan</label>
          <textarea id="keterangan" class="form-control" rows="2" placeholder="Catatan tambahan (opsional)"></textarea>
        </div>
      </div>
    </div>

    <div class="section-title">Daftar Barang Pembelian</div>

    <div class="summary-box">
      <div class="summary-item">
        <h6>üì¶ Total Item</h6>
        <h2 id="totalItem">0</h2>
      </div>
      <div class="summary-item">
        <h6>üí∞ Total Harga</h6>
        <h2 id="totalHarga">Rp. 0</h2>
      </div>
    </div>

    <table class="table table-bordered align-middle" id="tabelPembelian">
      <thead>
        <tr>
          <th>Kode</th>
          <th>Nama Barang</th>
          <th>Harga Beli</th>
          <th>Margin (%)</th>
          <th>Harga Jual</th>
          <th>Stok</th>
          <th>Item</th>
          <th>Subtotal</th>
          <th>Aksi</th>
        </tr>
      </thead>
      <tbody>
        <tr id="inputRow" style="background: #f0f8f5;">
          <td colspan="9" style="padding: 15px;">
            <div class="input-wrapper" style="position:relative;">
              <input type="text" id="kode_barang" class="form-control" placeholder="Ketik kode/nama barang..." autocomplete="off" autofocus style="flex: 1;" />
              <div id="autocompleteList" style="position:absolute;top:100%;left:0;right:0;z-index:10;display:none;background:#fff;border:1px solid #dcecdc;border-radius:0 0 8px 8px;max-height:250px;overflow-y:auto;"></div>
            </div>
          </td>
        </tr>
      </tbody>
    </table>

    <div class="text-end mt-4">
      <button id="btnSimpan" class="btn-save">üíæ Simpan Transaksi</button>
    </div>
  </div>

  <!-- Hapus scanner overlay -->
  <!--
  <div class="scanner-overlay" id="scannerOverlay">
    ...scanner code...
  </div>
  -->

  <div class="loading-overlay" id="loadingOverlay">
    <div class="loading-content">
      <div class="loading-spinner"></div>
      <h4 style="color: var(--green-main); margin: 0;">Menyimpan transaksi...</h4>
      <p style="color: #666; margin-top: 10px;">Mohon tunggu sebentar</p>
    </div>
  </div>

  <script>
    $(document).ready(function () {
      let barangData = [];
      let supplierData = [];

      const today = new Date().toISOString().split('T')[0];
      $("#tanggal_pembelian").val(today);

      // Load supplier data dari database
      function loadSuppliers() {
        $.ajax({
          url: "/api/supplier",
          method: "GET",
          success: function(res) {
            if (!res.error) {
              supplierData = res.suppliers;
              let options = '<option value="">-- Pilih Supplier --</option>';
              supplierData.forEach(function(supplier) {
                if (supplier.status === 'aktif') {
                  options += `<option value="${supplier.id_supplier}">${supplier.nama_supplier}</option>`;
                }
              });
              $("#supplier").html(options);
            } else {
              $("#supplier").html('<option value="">-- Gagal memuat data supplier --</option>');
            }
          },
          error: function(xhr) {
            $("#supplier").html('<option value="">-- Gagal memuat data supplier --</option>');
          }
        });
      }
      loadSuppliers();

      // Tombol dashboard, back, forward
      $("#btnDashboard").click(function() {
        window.location.href = "/stok";
      });
      $("#btnBack").click(function() {
        window.history.back();
      });
      $("#btnForward").click(function() {
        window.history.forward();
      });

      // Hapus semua kode terkait scanner/kamera
      // $("#btnOpenScanner").click(function() { ... });
      // $("#btnCloseScanner").click(function() { ... });

      function formatRupiah(angka) {
        angka = parseFloat(angka) || 0;
        return "Rp. " + angka.toLocaleString("id-ID");
      }

      function unformatRupiah(text) {
        return parseInt(String(text).replace(/[^\d]/g, "")) || 0;
      }

      function formatPersen(angka) {
        angka = parseFloat(angka) || 0;
        return angka + "%";
      }

      function unformatPersen(text) {
        return parseFloat(String(text).replace(/[^\d.]/g, "")) || 0;
      }

      function tambahBarang(kode) {
        if (!kode) return;

        // Ambil data barang dulu
        $.getJSON(`/get_barang/${kode}`, function (data) {
          if (data.error) {
            alert(data.message || "Kode barang tidak ditemukan!");
            $("#kode_barang").val("").focus();
            return;
          }

          // Ambil harga beli terakhir tertinggi
          $.getJSON(`/get_harga_beli_tertinggi/${data.kode_barang}`, function (hargaRes) {
            let hargaBeli = data.harga_beli || 0;
            if (!hargaRes.error && hargaRes.harga_beli_tertinggi) {
              hargaBeli = hargaRes.harga_beli_tertinggi;
            }
            const row = `
              <tr data-id="${data.id_detail}">
                <td class="text-center">${data.kode_barang}</td>
                <td>${data.nama_barang}</td>
                <td><input type="text" class="form-control text-end harga_beli" value="${formatRupiah(hargaBeli)}"></td>
                <td><input type="text" class="form-control text-end margin" value="%"></td>
                <td><input type="text" class="form-control text-end harga_jual" value="${formatRupiah(data.harga_jual || 0)}"></td>
                <td class="text-center">${data.stok || 0}</td>
                <td><input type="number" class="form-control text-end jumlah" value="1" min="1"></td>
                <td class="text-end subtotal">${formatRupiah(hargaBeli)}</td>
                <td class="text-center"><button class="btn-delete" onclick="hapusBarang(this)">üóëÔ∏è Hapus</button></td>
              </tr>`;
            $("#inputRow").before(row);
            $("#kode_barang").val("");
            const newRow = $("#tabelPembelian tbody tr").not("#inputRow").last();
            newRow.find(".harga_beli").focus().select();
            updateTotal();
          }).fail(function () {
            // Jika gagal ambil harga tertinggi, fallback ke harga default
            const hargaBeli = data.harga_beli || 0;
            const row = `
              <tr data-id="${data.id_detail}">
                <td class="text-center">${data.kode_barang}</td>
                <td>${data.nama_barang}</td>
                <td><input type="text" class="form-control text-end harga_beli" value="${formatRupiah(hargaBeli)}"></td>
                <td><input type="text" class="form-control text-end margin" value="%"></td>
                <td><input type="text" class="form-control text-end harga_jual" value="${formatRupiah(data.harga_jual || 0)}"></td>
                <td class="text-center">${data.stok || 0}</td>
                <td><input type="number" class="form-control text-end jumlah" value="1" min="1"></td>
                <td class="text-end subtotal">${formatRupiah(hargaBeli)}</td>
                <td class="text-center"><button class="btn-delete" onclick="hapusBarang(this)">üóëÔ∏è Hapus</button></td>
              </tr>`;
            $("#inputRow").before(row);
            $("#kode_barang").val("");
            const newRow = $("#tabelPembelian tbody tr").not("#inputRow").last();
            newRow.find(".harga_beli").focus().select();
            updateTotal();
          });
        }).fail(function () {
          alert("Gagal mengambil data barang dari server!");
        });
      }

      window.hapusBarang = function(btn) {
        if (confirm("Apakah Anda yakin ingin menghapus barang ini?")) {
          $(btn).closest("tr").remove();
          updateTotal();
          $("#kode_barang").focus();
        }
      };

      $("#kode_barang").keypress(function (e) {
        if (e.which === 13) {
          const kode = $(this).val().trim();
          tambahBarang(kode);
        }
      });

      $(document).on("input", ".harga_beli, .harga_jual", function () {
        let val = $(this).val().replace(/[^\d]/g, "");
        if (val === "") val = "0";
        $(this).val(formatRupiah(val));
      });

      $(document).on("input", ".margin", function (e) {
        let val = $(this).val();
        val = val.replace(/[^\d.]/g, "");
        if (val === "") {
          $(this).val("%");
          this.setSelectionRange(0, 0);
          return;
        }
        if (parseFloat(val) > 100) val = "100";
        $(this).val(val + "%");
        const pos = val.length;
        this.setSelectionRange(pos, pos);
      });

      $(document).on("focus", ".margin", function () {
        const val = $(this).val();
        if (val === "" || val === "%") {
          $(this).val("%");
          this.setSelectionRange(0, 0);
        } else {
          const numLength = val.replace(/[^\d.]/g, "").length;
          this.setSelectionRange(numLength, numLength);
        }
      });

      $(document).on("click", ".margin", function () {
        const val = $(this).val();
        const numLength = val.replace(/[^\d.]/g, "").length;
        this.setSelectionRange(numLength, numLength);
      });

      $(document).on("keydown", ".harga_beli", function (e) {
        if (e.key === "Enter") {
          e.preventDefault();
          $(this).closest("tr").find(".margin").focus().select();
        }
      });

      $(document).on("keydown", ".margin", function (e) {
        if (e.key === "Enter") {
          e.preventDefault();
          $(this).closest("tr").find(".harga_jual").focus().select();
        }
      });

      $(document).on("keydown", ".harga_jual", function (e) {
        if (e.key === "Enter") {
          e.preventDefault();
          $(this).closest("tr").find(".jumlah").focus().select();
        }
      });

      $(document).on("keydown", ".jumlah", function (e) {
        if (e.key === "Enter") {
          e.preventDefault();
          $("#kode_barang").focus();
        }
      });

      $(document).on("input", ".harga_beli, .margin, .harga_jual, .jumlah", function () {
        const row = $(this).closest("tr");
        const beli = unformatRupiah(row.find(".harga_beli").val());
        let jual = unformatRupiah(row.find(".harga_jual").val());
        let margin = unformatPersen(row.find(".margin").val());

        if ($(this).hasClass("margin")) {
          jual = beli + (beli * margin) / 100;
          jual = Math.round(jual);
          row.find(".harga_jual").val(formatRupiah(jual));
        }

        if ($(this).hasClass("harga_jual")) {
          margin = ((jual - beli) / beli) * 100;
          margin = isFinite(margin) ? Math.round(margin * 100) / 100 : 0;
          row.find(".margin").val(formatPersen(margin));
        }

        const jumlah = parseInt(row.find(".jumlah").val()) || 0;
        const subtotal = beli * jumlah;
        row.find(".subtotal").text(formatRupiah(subtotal));

        updateTotal();
      });

      function updateTotal() {
        let total = 0, item = 0;
        $("#tabelPembelian tbody tr").each(function () {
          if ($(this).attr("id") === "inputRow") return;
          const subtotal = unformatRupiah($(this).find(".subtotal").text());
          const jumlah = parseInt($(this).find(".jumlah").val()) || 0;
          total += subtotal;
          item += jumlah;
        });
        $("#totalHarga").text(formatRupiah(total));
        $("#totalItem").text(item);
      }

      // Pada proses simpan, gunakan supplier_id dan pastikan nominal integer
      $("#btnSimpan").click(function () {
        const tanggal = $("#tanggal_pembelian").val();
        const supplierId = $("#supplier").val();
        const metodePembayaran = $("#metode_pembayaran").val();

        if (!tanggal) {
          alert("Tanggal pembelian harus diisi!");
          $("#tanggal_pembelian").focus();
          return;
        }
        if (!supplierId) {
          alert("Supplier harus dipilih!");
          $("#supplier").focus();
          return;
        }
        if (!metodePembayaran) {
          alert("Metode pembayaran harus dipilih!");
          $("#metode_pembayaran").focus();
          return;
        }

        const items = [];
        $("#tabelPembelian tbody tr").each(function () {
          if ($(this).attr("id") === "inputRow") return;
          const row = $(this);
          items.push({
            id_detail: row.data("id"),
            harga_beli: unformatRupiah(row.find(".harga_beli").val()), // integer
            margin: unformatPersen(row.find(".margin").val()),
            harga_jual: unformatRupiah(row.find(".harga_jual").val()), // integer
            jumlah: parseInt(row.find(".jumlah").val()) || 0,
          });
        });

        if (!items.length) {
          alert("Belum ada barang di tabel!");
          return;
        }

        const dataTransaksi = {
          tanggal_pembelian: tanggal,
          nomor_faktur_supplier: $("#nomor_faktur").val().trim(),
          supplier_id: supplierId,
          metode_pembayaran: metodePembayaran,
          keterangan: $("#keterangan").val().trim(),
          items: items
        };

        $("#loadingOverlay").css("display", "flex");

        $.ajax({
          url: "/pembelian",
          method: "POST",
          contentType: "application/json",
          data: JSON.stringify(dataTransaksi),
          success: function (res) {
            $("#loadingOverlay").hide();
            if (res.error) {
              alert(res.message);
              return;
            }
            alert(res.message); // Tidak tampilkan nomor faktur
            // Ganti redirect ke dashboard atau halaman lain
            window.location.href = "/pembelian";
          },
          error: function (xhr) {
            $("#loadingOverlay").hide();
            const errorMsg = xhr.responseJSON ? xhr.responseJSON.message : "Gagal menyimpan transaksi!";
            alert(errorMsg);
          },
        });
      });
    });
  </script>
</body>
</html>