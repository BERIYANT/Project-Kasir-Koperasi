<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Kasir Koperasi - Penjualan</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

  <style>
    :root {
      --green-main: #2d7a4f;
      --green-light: #e8f5e9;
      --green-dark: #1a5738;
      --gray-bg: #f9f9f9;
    }

    body {
      background: var(--gray-bg);
      font-family: "Poppins", "Segoe UI", sans-serif;
      color: #333;
      min-height: 100vh;
    }

    .navbar {
      background: var(--green-main);
      color: #fff;
      padding: 1.2rem 2rem;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15);
    }

    .navbar h3 {
      margin: 0;
      font-weight: 700;
      font-size: 1.8rem;
    }

    .content {
      max-width: 1400px;
      margin: 40px auto;
      background: #fff;
      padding: 30px 40px;
      border-radius: 12px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
    }

    .section-title {
      font-size: 1.4rem;
      font-weight: 600;
      color: var(--green-main);
      margin-bottom: 20px;
    }

    .customer-box {
      background: linear-gradient(135deg, #fff 0%, var(--green-light) 100%);
      border: 2px solid var(--green-main);
      border-radius: 12px;
      padding: 25px 30px;
      margin-bottom: 30px;
      box-shadow: 0 3px 10px rgba(45, 122, 79, 0.1);
      transition: opacity 0.3s ease;
    }

    .customer-box.disabled {
      opacity: 0.5;
      pointer-events: none;
    }

    .customer-box h5 {
      color: var(--green-main);
      font-weight: 700;
      margin-bottom: 20px;
      font-size: 1.2rem;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .form-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 20px;
      margin-bottom: 15px;
    }

    .form-group {
      display: flex;
      flex-direction: column;
    }

    .form-group label {
      font-weight: 600;
      color: var(--green-dark);
      margin-bottom: 8px;
      font-size: 0.95rem;
    }

    .input-wrapper {
      display: flex;
      gap: 10px;
      align-items: center;
      width: 100%;
    }

    .input-wrapper input {
      flex: 1;
    }

    .btn-scan {
      background: var(--green-main);
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      white-space: nowrap;
      font-size: 0.9rem;
      transition: opacity 0.3s ease;
    }

    .btn-scan:hover {
      background: var(--green-dark);
    }

    .btn-scan.disabled {
      opacity: 0.5;
      pointer-events: none;
    }

    .input-with-icon {
      position: relative;
      display: flex;
      align-items: center;
    }

    .input-with-icon input {
      padding-right: 32px;
      width: 100%;
    }

    .input-with-icon .icon-suffix {
      position: absolute;
      right: 10px;
      color: var(--green-dark);
      font-weight: 600;
      font-size: 0.8rem;
      pointer-events: none;
      user-select: none;
    }

    .scanner-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.9);
      z-index: 9999;
      justify-content: center;
      align-items: center;
    }

    .scanner-overlay.active {
      display: flex;
    }

    .scanner-box {
      background: white;
      padding: 30px;
      border-radius: 12px;
      max-width: 600px;
      width: 90%;
      text-align: center;
    }

    .scanner-box h4 {
      color: var(--green-main);
      margin-bottom: 20px;
      font-weight: 600;
    }

    #reader {
      border: 3px solid var(--green-main);
      border-radius: 8px;
      overflow: hidden;
      max-width: 100%;
    }

    .scanner-hint {
      margin-top: 15px;
      color: #666;
      font-size: 0.9rem;
    }

    .btn-close-scanner {
      background: #dc3545;
      color: white;
      border: none;
      padding: 12px 30px;
      border-radius: 8px;
      margin-top: 20px;
      cursor: pointer;
      font-weight: 600;
    }

    .btn-close-scanner:hover {
      background: #c82333;
    }

    .summary-box {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      background: linear-gradient(135deg, var(--green-light) 0%, #c8e6c9 100%);
      padding: 30px;
      border-radius: 12px;
      margin-bottom: 25px;
      box-shadow: 0 3px 10px rgba(45, 122, 79, 0.15);
      border: 2px solid var(--green-main);
    }

    .summary-item {
      text-align: center;
    }

    .summary-item h6 {
      color: var(--green-dark);
      font-size: 1rem;
      margin-bottom: 8px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      font-weight: 700;
    }

    .summary-item h2 {
      margin: 0;
      font-weight: 800;
      color: #1a5738;
      font-size: 1.8rem;
      text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
    }

    table {
      border-radius: 10px;
      overflow: visible;
      width: 100%;
      position: relative;
    }

    thead {
      background: var(--green-main);
      color: white;
    }

    thead th {
      text-transform: uppercase;
      font-weight: 600;
      text-align: center;
      padding: 15px 10px;
      font-size: 0.85rem;
    }

    tbody td {
      vertical-align: middle;
      padding: 12px 10px;
      position: relative;
      font-size: 0.9rem;
    }

    tbody tr:not(#rowInput):not(.error-row):hover {
      background: var(--green-light);
      transition: 0.3s ease;
    }

    tbody tr.error-row {
      background: #ffe6e6 !important;
      animation: pulse-error 1.5s ease-in-out infinite;
      position: relative;
    }

    tbody tr.error-row > td {
      position: relative;
      color: #333;
    }

    tbody tr.error-row > td:not(:nth-child(5)):not(:nth-child(10))::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(255, 255, 255, 0.75);
      pointer-events: none;
      z-index: 1;
    }

    tbody tr.error-row > td:not(:nth-child(5)):not(:nth-child(10)) {
      color: #999 !important;
    }

    tbody tr.error-row > td:nth-child(5) {
      opacity: 1 !important;
      position: relative;
      z-index: 10;
      color: #333 !important;
      font-weight: 600 !important;
    }

    tbody tr.error-row > td:nth-child(10) {
      opacity: 1 !important;
      position: relative;
      z-index: 10;
    }

    table.disabled tbody tr.error-row > td:nth-child(5),
    table.disabled tbody tr.error-row > td:nth-child(10) {
      opacity: 1 !important;
    }

    table.disabled tbody tr:not(.error-row) > td::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(255, 255, 255, 0.5);
      pointer-events: none;
      z-index: 1;
    }

    table.disabled tbody tr:not(.error-row) > td {
      color: #aaa;
    }

    tbody tr.error-row .jumlah {
      background: #FFFFFF !important;
      border: 4px solid #FF4444 !important;
      color: #000000 !important;
      font-weight: 700 !important;
      font-size: 1.15rem !important;
      box-shadow: 
        0 0 0 4px rgba(255, 68, 68, 0.3),
        0 0 25px rgba(255, 68, 68, 0.9),
        0 6px 20px rgba(0, 0, 0, 0.4) !important;
      transform: scale(1.1) !important;
      position: relative !important;
      z-index: 1000 !important;
      border-radius: 8px !important;
      padding: 12px !important;
      animation: super-bright-glow 2s ease-in-out infinite !important;
      opacity: 1 !important;
    }

    @keyframes super-bright-glow {
      0%, 100% {
        box-shadow: 
          0 0 0 4px rgba(255, 68, 68, 0.3),
          0 0 25px rgba(255, 68, 68, 0.9),
          0 6px 20px rgba(0, 0, 0, 0.4);
      }
      50% {
        box-shadow: 
          0 0 0 6px rgba(255, 68, 68, 0.5),
          0 0 40px rgba(255, 68, 68, 1),
          0 8px 25px rgba(0, 0, 0, 0.5);
      }
    }

    tbody tr.error-row .jumlah:disabled,
    tbody tr.error-row .jumlah[disabled],
    table.disabled tbody tr.error-row .jumlah,
    table.disabled tbody tr.error-row .jumlah:disabled {
      background: #FFFFFF !important;
      border: 4px solid #FF4444 !important;
      color: #000000 !important;
      font-weight: 700 !important;
      opacity: 1 !important;
      cursor: text !important;
      pointer-events: auto !important;
      -webkit-text-fill-color: #000000 !important;
    }

    tbody tr.error-row .jumlah:focus,
    table.disabled tbody tr.error-row .jumlah:focus {
      border-color: #FF0000 !important;
      box-shadow: 
        0 0 0 5px rgba(255, 0, 0, 0.4),
        0 0 45px rgba(255, 0, 0, 1),
        0 10px 30px rgba(0, 0, 0, 0.6) !important;
      outline: none !important;
      background: #FFFFFF !important;
      transform: scale(1.15) !important;
      animation: none !important;
      opacity: 1 !important;
    }

    @keyframes pulse-error {
      0%, 100% { background: #ffe6e6; }
      50% { background: #ffcccc; }
    }

    #rowInput td {
      background: #f0f8f5;
      padding: 15px !important;
    }

    .form-control, .form-select {
      font-size: 16px;
      border: 1.5px solid #dcecdc;
      border-radius: 8px;
      padding: 10px 12px;
    }

    .form-control:focus, .form-select:focus {
      border-color: var(--green-main);
      box-shadow: 0 0 0 3px rgba(45, 122, 79, 0.15);
    }

    .form-control.error {
      border-color: #dc3545;
      background: #ffe6e6;
    }

    .form-control:disabled, .form-select:disabled {
      opacity: 0.3;
      background: #f5f5f5;
      color: #888;
    }

    .form-control.jumlah:not(.error-row .jumlah) {
      opacity: 1 !important;
      background: #ffffff !important;
      color: #000000 !important;
    }

    .btn-delete {
      background: #dc3545;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 6px;
      font-weight: 600;
      cursor: pointer;
      font-size: 0.85rem;
      transition: all 0.3s ease;
      white-space: nowrap;
    }

    .btn-delete:hover:not(:disabled) {
      background: #c82333;
      transform: scale(1.05);
    }

    .btn-delete:disabled {
      opacity: 0.3;
      cursor: not-allowed;
    }

    .btn-save {
      background: var(--green-main);
      color: #fff;
      border: none;
      padding: 15px 40px;
      font-size: 1.1rem;
      font-weight: 600;
      border-radius: 10px;
      transition: all 0.3s ease;
    }

    .btn-save:hover:not(:disabled) {
      background: var(--green-dark);
      transform: translateY(-2px);
      box-shadow: 0 6px 15px rgba(45, 122, 79, 0.3);
    }

    .btn-save:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .loading-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      z-index: 9999;
      justify-content: center;
      align-items: center;
    }

    .loading-content {
      background: white;
      padding: 40px;
      border-radius: 12px;
      text-align: center;
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
    }

    .loading-spinner {
      border: 5px solid #f3f3f3;
      border-top: 5px solid var(--green-main);
      border-radius: 50%;
      width: 60px;
      height: 60px;
      animation: spin 1s linear infinite;
      margin: 0 auto 20px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .error-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      z-index: 10000;
      justify-content: center;
      align-items: center;
    }

    .error-modal.active {
      display: flex;
    }

    .error-modal-content {
      background: white;
      padding: 40px;
      border-radius: 12px;
      max-width: 500px;
      width: 90%;
      text-align: center;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
      animation: shake 0.5s ease-in-out;
    }

    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      10%, 30%, 50%, 70%, 90% { transform: translateX(-10px); }
      20%, 40%, 60%, 80% { transform: translateX(10px); }
    }

    .error-modal-content .error-icon {
      font-size: 4rem;
      color: #dc3545;
      margin-bottom: 20px;
    }

    .error-modal-content h3 {
      color: #dc3545;
      font-weight: 700;
      margin-bottom: 15px;
    }

    .error-modal-content p {
      color: #666;
      font-size: 1.1rem;
      margin-bottom: 10px;
    }

    .error-modal-content .stock-info {
      background: #ffe6e6;
      padding: 15px;
      border-radius: 8px;
      margin: 20px 0;
      border: 2px solid #dc3545;
    }

    .error-modal-content .stock-info strong {
      color: #dc3545;
      font-size: 1.3rem;
    }

    .btn-close-error {
      background: #dc3545;
      color: white;
      border: none;
      padding: 12px 30px;
      border-radius: 8px;
      margin-top: 20px;
      cursor: pointer;
      font-weight: 600;
      font-size: 1rem;
    }

    .btn-close-error:hover {
      background: #c82333;
    }

    .custom-alert {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      z-index: 10001;
      justify-content: center;
      align-items: center;
    }

    .custom-alert.active {
      display: flex;
    }

    .alert-content {
      background: white;
      padding: 30px;
      border-radius: 12px;
      max-width: 450px;
      width: 90%;
      text-align: center;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
    }

    .alert-icon {
      font-size: 3rem;
      margin-bottom: 20px;
    }

    .alert-icon.info { color: #17a2b8; }
    .alert-icon.success { color: #28a745; }
    .alert-icon.warning { color: #ffc107; }
    .alert-icon.error { color: #dc3545; }

    .alert-content h4 {
      margin-bottom: 15px;
      font-weight: 600;
    }

    .alert-content p {
      color: #666;
      margin-bottom: 25px;
      font-size: 1rem;
      line-height: 1.5;
    }

    .alert-buttons {
      display: flex;
      gap: 10px;
      justify-content: center;
    }

    .btn-alert {
      padding: 10px 25px;
      border: none;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .btn-alert-ok {
      background: var(--green-main);
      color: white;
    }

    .btn-alert-ok:hover {
      background: var(--green-dark);
    }

    .btn-alert-close {
      background: #6c757d;
      color: white;
    }

    .btn-alert-close:hover {
      background: #5a6268;
    }

    .table-responsive {
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
    }

    @media (max-width: 768px) {
      .form-row {
        grid-template-columns: 1fr;
      }

      thead th {
        font-size: 0.7rem;
        padding: 10px 5px;
      }

      tbody td {
        padding: 8px 5px;
        font-size: 0.8rem;
      }

      .form-control {
        font-size: 14px;
        padding: 8px;
      }

      .alert-buttons {
        flex-direction: column;
      }
    }
  </style>
</head>
<body>
  <nav class="navbar">
    <h3>üßæ Kasir Koperasi <small style="font-size: 1rem; opacity: 0.8;">‚Ä¢ Penjualan Barang</small></h3>
    <div style="margin-top: 10px;">
      <button id="btnBack" class="btn btn-secondary me-2">‚¨Ö Kembali</button>
      <button id="btnForward" class="btn btn-secondary">‚û° Maju</button>
    </div>
  </nav>

  <div class="content">
    <div class="customer-box" id="customerBox">
      <h5>üë§ Data Pembeli</h5>
      
      <div class="form-row">
        <div class="form-group">
          <label for="nama_pembeli">Nama Pembeli</label>
          <input type="text" id="nama_pembeli" class="form-control" placeholder="Masukkan nama pembeli (opsional)">
        </div>

        <div class="form-group">
          <label for="nomor_telepon">Nomor Telepon</label>
          <input type="text" id="nomor_telepon" class="form-control" placeholder="Contoh: 08123456789">
        </div>

        <div class="form-group">
          <label for="metode_pembayaran">Metode Pembayaran</label>
          <select id="metode_pembayaran" class="form-select">
            <option value="Tunai" selected>Tunai</option>
            <option value="Transfer">Transfer Bank</option>
            <option value="QRIS">QRIS</option>
            <option value="Debit">Kartu Debit</option>
            <option value="Kredit">Kartu Kredit</option>
          </select>
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label for="keterangan">Keterangan</label>
          <textarea id="keterangan" class="form-control" rows="2" placeholder="Catatan tambahan (opsional)"></textarea>
        </div>
      </div>
    </div>

    <div class="section-title">Daftar Penjualan</div>

    <div class="summary-box">
      <div class="summary-item">
        <h6>üì¶ Total Item</h6>
        <h2 id="totalItem">0</h2>
      </div>
      <div class="summary-item">
        <h6>üí∞ Subtotal</h6>
        <h2 id="subtotalHarga">Rp. 0</h2>
      </div>
      <div class="summary-item">
        <h6>üéÅ Total Diskon</h6>
        <h2 id="totalDiskon" style="color: #dc3545;">Rp. 0</h2>
      </div>
      <div class="summary-item">
        <h6>üíµ Total Bayar</h6>
        <h2 id="totalHarga" style="color: #1a5738; font-size: 2rem;">Rp. 0</h2>
      </div>
    </div>

    <div class="table-responsive">
      <table class="table table-bordered align-middle" id="tabelKasir">
        <thead>
          <tr>
            <th style="width: 90px;">Kode</th>
            <th style="width: 180px;">Nama Barang</th>
            <th style="width: 110px;">Harga Jual</th>
            <th style="width: 70px;">Stok</th>
            <th style="width: 90px;">Item</th>
            <th style="width: 110px;">Subtotal</th>
            <th style="width: 90px;">Promo (%)</th>
            <th style="width: 110px;">Diskon (Rp)</th>
            <th style="width: 110px;">Total</th>
            <th style="width: 90px;">Aksi</th>
          </tr>
        </thead>
        <tbody>
          <tr id="rowInput" style="background: #f0f8f5;">
            <td colspan="10" style="padding: 15px;">
              <div class="input-wrapper">
                <input type="text" id="kode_barang" class="form-control" placeholder="Ketik kode barang atau barcode..." autofocus style="flex: 1;" />
                <!-- Tombol scan dihapus -->
              </div>
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <div class="text-end mt-4">
      <button id="btnSimpan" class="btn-save">üíæ Simpan Transaksi</button>
    </div>
  </div>

  <!-- Scanner overlay dihapus -->
  <!--
  <div class="scanner-overlay" id="scannerOverlay">
    <div class="scanner-box">
      <h4>üì∑ Scan Barcode</h4>
      <div id="reader"></div>
      <div class="scanner-hint">
        Arahkan kamera ke barcode CODE128<br>
        Scanner akan otomatis membaca barcode
      </div>
      <button class="btn-close-scanner" id="btnCloseScanner">‚úñ Tutup Scanner</button>
    </div>
  </div>
  -->

  <div class="error-modal" id="errorModal">
    <div class="error-modal-content">
      <div class="error-icon">‚ö†Ô∏è</div>
      <h3>Stok Tidak Mencukupi!</h3>
      <p id="errorMessage">Item yang Anda masukkan melebihi stok yang tersedia</p>
      <div class="stock-info">
        <p style="margin: 0; color: #666;">Stok Tersedia:</p>
        <strong id="availableStock">0</strong> item
      </div>
      <p style="font-size: 0.9rem; color: #999; margin-top: 15px;">
        Silakan perbaiki jumlah item terlebih dahulu
      </p>
      <button class="btn-close-error" id="btnCloseError">‚úñ Tutup</button>
    </div>
  </div>

  <div class="custom-alert" id="customAlert">
    <div class="alert-content">
      <div class="alert-icon" id="alertIcon">‚ÑπÔ∏è</div>
      <h4 id="alertTitle">Informasi</h4>
      <p id="alertMessage">Pesan akan muncul di sini</p>
      <div class="alert-buttons">
        <button class="btn-alert btn-alert-ok" id="btnAlertOk">OK</button>
      </div>
    </div>
  </div>

  <div class="loading-overlay" id="loadingOverlay">
    <div class="loading-content">
      <div class="loading-spinner"></div>
      <h4 style="color: var(--green-main); margin: 0;">Menyimpan transaksi...</h4>
      <p style="color: #666; margin-top: 10px;">Mohon tunggu sebentar</p>
    </div>
  </div>

  <script>
    $(document).ready(function() {
      let isScanning = false;
      let hasStockError = false;

      function showAlert(title, message, type = "info") {
        const iconMap = {
          "info": "‚ÑπÔ∏è",
          "success": "‚úÖ",
          "warning": "‚ö†Ô∏è",
          "error": "‚ùå"
        };
        
        $("#alertIcon").attr("class", "alert-icon " + type).text(iconMap[type]);
        $("#alertTitle").text(title);
        $("#alertMessage").text(message);
        $("#customAlert").addClass("active");
        
        setTimeout(() => {
          $("#btnAlertOk").focus();
        }, 100);
      }

      function hideAlert() {
        $("#customAlert").removeClass("active");
        setTimeout(() => {
          if (!hasStockError) {
            $("#kode_barang").focus();
          }
        }, 100);
      }

      $("#btnAlertOk").click(function() {
        hideAlert();
      });

      $(document).on("click", "#customAlert", function(e) {
        if (e.target.id === "customAlert") {
          hideAlert();
        }
      });

      $(document).on("keydown", function(e) {
        if (e.key === "Escape" && $("#customAlert").hasClass("active")) {
          hideAlert();
        }
      });

      function formatRupiah(angka) {
        angka = parseInt(angka) || 0;
        return "Rp. " + angka.toLocaleString("id-ID");
      }

      function unformatRupiah(text) {
        return parseInt(String(text).replace(/[^\d]/g, "")) || 0;
      }

      function formatAngkaDisplay(angka) {
        angka = parseInt(angka) || 0;
        return angka.toLocaleString("id-ID");
      }

      function setUIState(disabled) {
        hasStockError = disabled;
        
        if (disabled) {
          $("#customerBox").addClass("disabled");
          $("#customerBox input, #customerBox select, #customerBox textarea").prop("disabled", true);
          
          $("#kode_barang").prop("disabled", true);
          $("#btnOpenScanner").addClass("disabled").prop("disabled", true);
          
          $("#btnSimpan").prop("disabled", true);
          
          $("#tabelKasir").addClass("disabled");
          $("#tabelKasir tbody tr input, #tabelKasir tbody tr select, #tabelKasir tbody tr button").prop("disabled", true);
          
          setTimeout(function() {
            $(".error-row .jumlah").each(function() {
              $(this).prop("disabled", false).removeAttr("disabled");
            });
          }, 50);
          
        } else {
          $("#customerBox").removeClass("disabled");
          $("#customerBox input, #customerBox select, #customerBox textarea").prop("disabled", false);
          
          $("#kode_barang").prop("disabled", false);
          $("#btnOpenScanner").removeClass("disabled").prop("disabled", false);
          
          $("#btnSimpan").prop("disabled", false);
          
          $("#tabelKasir").removeClass("disabled");
          $("#tabelKasir tbody tr input, #tabelKasir tbody tr select, #tabelKasir tbody tr button").prop("disabled", false);
        }
      }

      function showStockError(namaBarang, stokTersedia, jumlahDiminta) {
        $("#errorMessage").text(`Anda memasukkan ${jumlahDiminta} item "${namaBarang}", tetapi stok hanya tersedia ${stokTersedia} item`);
        $("#availableStock").text(stokTersedia);
        $("#errorModal").addClass("active");
        setUIState(true);
      }

      function hideStockError() {
        $("#errorModal").removeClass("active");
        
        if ($(".error-row").length === 0) {
          setUIState(false);
          
          setTimeout(function() {
            $("#kode_barang").focus();
          }, 100);
        } else {
          setTimeout(function() {
            const errorInput = $(".error-row").first().find(".jumlah");
            errorInput.prop("disabled", false).removeAttr("disabled").focus().select();
          }, 100);
        }
      }

      $("#btnCloseError").click(function() {
        hideStockError();
      });

      $(document).on("click", "#errorModal", function(e) {
        if (e.target.id === "errorModal") {
          hideStockError();
        }
      });

      $(document).on("keydown", function(e) {
        if (e.key === "Escape" && $("#errorModal").hasClass("active")) {
          hideStockError();
        }
      });

      function validateStock(row) {
        const stok = parseInt(row.data("stok")) || 0;
        const jumlah = parseInt(row.find(".jumlah").val()) || 0;
        const namaBarang = row.find("td:nth-child(2)").text();
        
        if (jumlah > stok) {
          row.addClass("error-row");
          row.find(".jumlah").addClass("error");
          showStockError(namaBarang, stok, jumlah);
          
          setUIState(true);
          
          setTimeout(function() {
            const errorInput = row.find(".jumlah");
            errorInput.prop("disabled", false).removeAttr("disabled").focus().select();
          }, 150);
          
          return false;
        } else {
          row.removeClass("error-row");
          row.find(".jumlah").removeClass("error");
          
          if ($(".error-row").length === 0) {
            hideStockError();
            setUIState(false);
          }
          return true;
        }
      }

      window.hapusBarang = function(btn) {
        if (hasStockError) return;
        
        if (confirm("Apakah Anda yakin ingin menghapus barang ini?")) {
          $(btn).closest("tr").remove();
          updateTotal();
          
          if ($(".error-row").length === 0) {
            hideStockError();
            setUIState(false);
          }
          
          $("#kode_barang").focus();
        }
      };

      function tambahBarang(kode) {
        if (!kode) return;

        $.ajax({
          url: "/get_barang/" + kode,
          method: "GET",
          dataType: "json",
          success: function(response) {
            if (response.error) {
              showAlert("Barang Tidak Ditemukan", response.message, "error");
              $("#kode_barang").val("").focus();
              return;
            }

            const data = response;
            
            const newRow = `
              <tr data-id="${data.id_detail}" data-stok="${data.stok}">
                <td class="text-center">${data.kode_barang}</td>
                <td>${data.nama_barang}</td>
                <td class="text-end harga_jual">${formatRupiah(data.harga_jual)}</td>
                <td class="text-center stok-display">${data.stok || 0}</td>
                <td><input type="text" class="form-control text-end jumlah" value="1" /></td>
                <td class="text-end subtotal">${formatRupiah(data.harga_jual)}</td>
                <td>
                  <div class="input-with-icon">
                    <input type="text" class="form-control text-end promo-input" value="0" maxlength="5">
                    <span class="icon-suffix">%</span>
                  </div>
                </td>
                <td>
                  <div class="input-with-icon">
                    <input type="text" class="form-control text-end diskon-nominal-input" value="0">
                    <span class="icon-suffix">Rp</span>
                  </div>
                </td>
                <td class="text-end total">${formatRupiah(data.harga_jual)}</td>
                <td class="text-center">
                  <button class="btn-delete" onclick="hapusBarang(this)">üóëÔ∏è</button>
                </td>
              </tr>`;
            
            $("#rowInput").before(newRow);

            updateTotal();

            const lastRow = $("#tabelKasir tbody tr").not("#rowInput").last();
            
            validateStock(lastRow);
            
            $("#kode_barang").val("");
            
            if (!hasStockError) {
              setTimeout(function() {
                lastRow.find(".jumlah").focus().select();
              }, 100);
            }
          },
          error: function(xhr, status, error) {
            console.error("Error fetching barang:", error);
            showAlert("Error", "Gagal mengambil data barang: " + error, "error");
            $("#kode_barang").val("").focus();
          }
        });
      }

      $(document).on("keydown", "#kode_barang", function(e) {
        if (e.key === "Enter" && !hasStockError) {
          e.preventDefault();
          const kode = $(this).val().trim();
          tambahBarang(kode);
        }
      });

      $("#btnCloseScanner").click(function() {
        if (html5QrcodeScanner && isScanning) {
          html5QrcodeScanner.stop().then(() => {
            $("#scannerOverlay").removeClass("active");
            isScanning = false;
            if (!hasStockError) {
              $("#kode_barang").focus();
            }
          }).catch(err => {
            console.error("Error stopping:", err);
            $("#scannerOverlay").removeClass("active");
            isScanning = false;
          });
        } else {
          $("#scannerOverlay").removeClass("active");
        }
      });

      $(document).on("input", ".promo-input", function() {
        let value = $(this).val().replace(/[^\d]/g, '');
        
        if (value === '') {
          $(this).val('0');
          value = '0';
        }
        
        let intValue = parseInt(value) || 0;
        if (intValue > 100) {
          intValue = 100;
        }
        
        $(this).val(intValue);
        
        if (!hasStockError) {
          const row = $(this).closest("tr");
          syncPromoToDiskon(row);
          hitungRow(row);
          updateTotal();
        }
      });

      $(document).on("blur", ".promo-input", function() {
        let value = $(this).val().replace(/[^\d]/g, '');
        
        if (value === '') {
          value = '0';
        }
        
        let intValue = parseInt(value) || 0;
        if (intValue > 100) {
          intValue = 100;
        }
        
        $(this).val(intValue);
        
        if (!hasStockError) {
          const row = $(this).closest("tr");
          syncPromoToDiskon(row);
          hitungRow(row);
          updateTotal();
        }
      });

      $(document).on("keydown", ".promo-input", function(e) {
        if (e.key === "Enter" && !hasStockError) {
          e.preventDefault();
          const row = $(this).closest("tr");
          syncPromoToDiskon(row);
          hitungRow(row);
          updateTotal();
          $("#kode_barang").focus();
        }
      });

      $(document).on("input", ".diskon-nominal-input", function() {
        let value = $(this).val().replace(/[^\d]/g, '');
        
        if (value === '') {
          $(this).val('0');
        } else {
          $(this).val(formatAngkaDisplay(parseInt(value)));
        }
        
        if (!hasStockError) {
          const row = $(this).closest("tr");
          syncDiskonToPromo(row);
          hitungRow(row);
          updateTotal();
        }
      });

      $(document).on("blur", ".diskon-nominal-input", function() {
        let value = $(this).val().replace(/[^\d]/g, '');
        
        if (value === '') {
          value = '0';
        }
        
        $(this).val(formatAngkaDisplay(parseInt(value)));
        
        if (!hasStockError) {
          const row = $(this).closest("tr");
          syncDiskonToPromo(row);
          hitungRow(row);
          updateTotal();
        }
      });

      $(document).on("focus", ".diskon-nominal-input", function() {
        let value = $(this).val().replace(/[^\d]/g, '');
        $(this).val(value);
        $(this).select();
      });

      $(document).on("keydown", ".diskon-nominal-input", function(e) {
        if (e.key === "Enter" && !hasStockError) {
          e.preventDefault();
          const row = $(this).closest("tr");
          syncDiskonToPromo(row);
          hitungRow(row);
          updateTotal();
          $("#kode_barang").focus();
        }
      });

      function syncPromoToDiskon(row) {
        const subtotal = unformatRupiah(row.find(".subtotal").text());
        const promoPersen = parseInt(row.find(".promo-input").val()) || 0;
        const diskonNominal = Math.round((subtotal * promoPersen) / 100);
        
        row.find(".diskon-nominal-input").val(formatAngkaDisplay(diskonNominal));
      }

      function syncDiskonToPromo(row) {
        const subtotal = unformatRupiah(row.find(".subtotal").text());
        const diskonNominal = parseInt(row.find(".diskon-nominal-input").val().replace(/[^\d]/g, '')) || 0;
        
        if (subtotal > 0) {
          let promoPersen = Math.round((diskonNominal * 100) / subtotal);
          
          if (promoPersen > 100) {
            promoPersen = 100;
            const maxDiskon = Math.round((subtotal * 100) / 100);
            row.find(".diskon-nominal-input").val(formatAngkaDisplay(maxDiskon));
          }
          
          row.find(".promo-input").val(promoPersen);
        }
      }

      $(document).on("keypress", ".jumlah", function(e) {
        const charCode = e.which || e.keyCode;
        
        if (charCode === 8 || charCode === 9 || charCode === 27 || charCode === 13 ||
            (charCode === 65 && e.ctrlKey === true) ||
            (charCode === 67 && e.ctrlKey === true) ||
            (charCode === 86 && e.ctrlKey === true) ||
            (charCode === 88 && e.ctrlKey === true) ||
            (charCode >= 35 && charCode <= 40)) {
          return;
        }
        
        if (charCode < 48 || charCode > 57) {
          e.preventDefault();
          return false;
        }
      });

      $(document).on("paste", ".jumlah", function(e) {
        e.preventDefault();
        
        const pastedData = (e.originalEvent || e).clipboardData.getData('text/plain');
        
        if (/^\d+$/.test(pastedData)) {
          const currentValue = parseInt(pastedData) || 0;
          const maxValue = parseInt($(this).closest("tr").data("stok")) || 999;
          
          if (currentValue <= maxValue && currentValue > 0) {
            $(this).val(currentValue);
          }
        }
      });

      $(document).on("keydown", ".jumlah", function(e) {
        if (e.key === "Enter") {
          e.preventDefault();
          
          const row = $(this).closest("tr");
          const inputValue = $(this).val().trim();
          
          if (!inputValue || inputValue === "" || parseInt(inputValue) === 0) {
            showAlert("Input Tidak Valid", "Jumlah item harus lebih dari 0", "warning");
            $(this).val("1");
            $(this).focus().select();
            return false;
          }
          
          if (validateStock(row)) {
            hitungRow(row);
            updateTotal();
            
            if (!hasStockError) {
              $(this).blur();
              
              setTimeout(function() {
                $("#kode_barang").focus();
              }, 100);
            }
          } else {
            $(this).focus().select();
          }
        }
        
        const allowedKeys = [
          'Backspace', 'Delete', 'Tab', 'Escape', 'Enter',
          'Home', 'End', 'ArrowLeft', 'ArrowRight', 'ArrowUp', 'ArrowDown'
        ];
        
        if (e.ctrlKey && ['a', 'c', 'v', 'x'].includes(e.key.toLowerCase())) {
          return true;
        }
        
        if (!allowedKeys.includes(e.key) && (e.key < '0' || e.key > '9')) {
          e.preventDefault();
          return false;
        }
      });

      $(document).on("blur", ".jumlah", function() {
        const row = $(this).closest("tr");
        const inputValue = $(this).val().trim();
        
        if (!inputValue || inputValue === "" || parseInt(inputValue) === 0) {
          $(this).val(1);
        }
        
        let cleanValue = $(this).val().replace(/[^\d]/g, '');
        if (cleanValue === "" || cleanValue === "0") {
          cleanValue = "1";
        }
        $(this).val(cleanValue);
        
        const isValid = validateStock(row);
        
        if (isValid) {
          hitungRow(row);
          updateTotal();
        }
      });

      $(document).on("input", ".jumlah", function() {
        let value = $(this).val();
        value = value.replace(/[^\d]/g, '');
        $(this).val(value);
      });

      $(document).on("click", ".error-row .jumlah", function(e) {
        e.stopPropagation();
        $(this).prop("disabled", false).removeAttr("disabled").focus().select();
      });

      function hitungRow(row) {
        const harga = unformatRupiah(row.find(".harga_jual").text());
        const jumlah = parseInt(row.find(".jumlah").val()) || 1;
        const subtotal = harga * jumlah;
        
        row.find(".subtotal").text(formatRupiah(subtotal));
        
        const diskonNominal = parseInt(row.find(".diskon-nominal-input").val().replace(/[^\d]/g, '')) || 0;
        
        const total = subtotal - diskonNominal;
        
        row.find(".total").text(formatRupiah(total));
        
        row.data("diskon", diskonNominal);
      }

      function updateTotal() {
        let totalItem = 0;
        let subtotalHarga = 0;
        let totalDiskonKeseluruhan = 0;
        let totalHarga = 0;

        $("#tabelKasir tbody tr").not("#rowInput").each(function() {
          const jumlah = parseInt($(this).find(".jumlah").val()) || 0;
          const subtotal = unformatRupiah($(this).find(".subtotal").text());
          const diskon = parseInt($(this).data("diskon")) || 0;
          const total = unformatRupiah($(this).find(".total").text());
          
          totalItem += jumlah;
          subtotalHarga += subtotal;
          totalDiskonKeseluruhan += diskon;
          totalHarga += total;
        });

        $("#totalItem").text(totalItem);
        $("#subtotalHarga").text(formatRupiah(subtotalHarga));
        $("#totalDiskon").text(formatRupiah(totalDiskonKeseluruhan));
        $("#totalHarga").text(formatRupiah(totalHarga));
      }

      function resetPenjualanForm() {
        $("#nama_pembeli").val("");
        $("#nomor_telepon").val("");
        $("#metode_pembayaran").val("Tunai");
        $("#keterangan").val("");
        
        $("#tabelKasir tbody tr").not("#rowInput").remove();
        
        $("#totalItem").text("0");
        $("#subtotalHarga").text("Rp. 0");
        $("#totalDiskon").text("Rp. 0");
        $("#totalHarga").text("Rp. 0");
        
        setUIState(false);
        hideStockError();
        hideAlert();
        
        setTimeout(function() {
          $("#kode_barang").val("").focus();
        }, 100);
      }

      $("#btnSimpan").click(function() {
        if (hasStockError) {
          showAlert("Kesalahan Stok", "Masih ada kesalahan stok! Silakan perbaiki terlebih dahulu.", "error");
          return;
        }

        const items = [];
        let hasError = false;

        $("#tabelKasir tbody tr").not("#rowInput").each(function() {
          const row = $(this);
          const stok = parseInt(row.data("stok")) || 0;
          const jumlah = parseInt(row.find(".jumlah").val()) || 0;

          if (jumlah > stok) {
            hasError = true;
            const namaBarang = row.find("td:nth-child(2)").text();
            showAlert(
              "Stok Tidak Mencukupi", 
              `Stok barang "${namaBarang}" tidak mencukupi!\nStok tersedia: ${stok}, Anda input: ${jumlah}`,
              "error"
            );
            return false;
          }

          const promoPersen = parseInt(row.find(".promo-input").val()) || 0;
          const diskonNominal = parseInt(row.find(".diskon-nominal-input").val().replace(/[^\d]/g, '')) || 0;

          items.push({
            id_detail: row.data("id"),
            jumlah: jumlah,
            harga_jual: unformatRupiah(row.find(".harga_jual").text()),
            promo_persen: promoPersen,
            diskon: diskonNominal,
            total: unformatRupiah(row.find(".total").text())
          });
        });

        if (hasError) {
          return;
        }

        if (!items.length) {
          showAlert("Tabel Kosong", "Belum ada barang di tabel!", "warning");
          return;
        }

        const dataTransaksi = {
          nama_pembeli: $("#nama_pembeli").val().trim(),
          nomor_telepon: $("#nomor_telepon").val().trim(),
          metode_pembayaran: $("#metode_pembayaran").val(),
          keterangan: $("#keterangan").val().trim(),
          subtotal: unformatRupiah($("#subtotalHarga").text()),
          total_diskon: unformatRupiah($("#totalDiskon").text()),
          total_bayar: unformatRupiah($("#totalHarga").text()),
          items: items
        };

        console.log("Data Transaksi:", dataTransaksi);

        $("#loadingOverlay").css("display", "flex");

        $.ajax({
          url: "/penjualan",
          method: "POST",
          contentType: "application/json",
          data: JSON.stringify(dataTransaksi),
          success: function(response) {
            $("#loadingOverlay").hide();
            
            if (response.error) {
              showAlert("Gagal Menyimpan", response.message, "error");
            } else {
              // Simpan data form untuk di-reset nanti
              const shouldReset = true;
              
              // Redirect ke halaman struk dengan auto print di tab yang sama
              window.location.href = `/struk/view/${response.id_faktur}?auto_print=1`;
            }
          },
          error: function(xhr, status, error) {
            $("#loadingOverlay").hide();
            console.error("Error:", xhr.responseJSON);
            
            let errorMsg = "Terjadi kesalahan saat menyimpan transaksi";
            if (xhr.responseJSON && xhr.responseJSON.message) {
              errorMsg = xhr.responseJSON.message;
            }
            
            showAlert("Error", errorMsg, "error");
          }
        });
      });

      // Tombol dashboard, back, forward
      $("#btnDashboard").click(function() {
        window.location.href = "/";
      });
      $("#btnBack").click(function() {
        window.history.back();
      });
      $("#btnForward").click(function() {
        window.history.forward();
      });
    });
  </script>
</body>
</html>